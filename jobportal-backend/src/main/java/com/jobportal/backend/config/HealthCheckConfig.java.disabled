package com.jobportal.backend.config;

import com.jobportal.backend.service.EmailService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.actuator.health.Health;
import org.springframework.boot.actuator.health.HealthIndicator;
import org.springframework.cache.CacheManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnection;
import org.springframework.data.redis.core.RedisTemplate;

import javax.sql.DataSource;

/**
 * Enterprise Health Monitoring Configuration
 * 
 * Features:
 * - Database connectivity health checks
 * - Cache system health monitoring
 * - Email service health verification
 * - Redis connectivity checks
 * - Custom business logic health checks
 * - Detailed health information for debugging
 */
@Slf4j
@Configuration
@RequiredArgsConstructor
public class HealthCheckConfig {

    /**
     * Database Health Indicator
     */
    @Bean
    public HealthIndicator databaseHealthIndicator(@Autowired DataSource dataSource) {
        return () -> {
            try {
                // Test database connectivity
                boolean isValid = dataSource.getConnection().isValid(5);
                if (isValid) {
                    return Health.up()
                            .withDetail("database", "PostgreSQL")
                            .withDetail("status", "Connected")
                            .withDetail("driver", "org.postgresql.Driver")
                            .build();
                } else {
                    return Health.down()
                            .withDetail("database", "PostgreSQL")
                            .withDetail("status", "Connection validation failed")
                            .build();
                }
            } catch (Exception e) {
                log.error("Database health check failed", e);
                return Health.down()
                        .withDetail("database", "PostgreSQL")
                        .withDetail("status", "Connection failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * Cache Health Indicator
     */
    @Bean
    public HealthIndicator cacheHealthIndicator(@Autowired CacheManager cacheManager) {
        return () -> {
            try {
                // Test cache accessibility
                var cacheNames = cacheManager.getCacheNames();
                boolean cacheAccessible = !cacheNames.isEmpty();
                
                if (cacheAccessible) {
                    return Health.up()
                            .withDetail("cache", "Active")
                            .withDetail("provider", cacheManager.getClass().getSimpleName())
                            .withDetail("caches", cacheNames)
                            .build();
                } else {
                    return Health.down()
                            .withDetail("cache", "No caches available")
                            .build();
                }
            } catch (Exception e) {
                log.error("Cache health check failed", e);
                return Health.down()
                        .withDetail("cache", "Failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * Redis Health Indicator (when Redis is configured)
     */
    @Bean
    public HealthIndicator redisHealthIndicator(@Autowired(required = false) RedisTemplate<String, Object> redisTemplate) {
        return () -> {
            if (redisTemplate == null) {
                return Health.up()
                        .withDetail("redis", "Not configured")
                        .build();
            }

            try {
                RedisConnection connection = redisTemplate.getConnectionFactory().getConnection();
                String pong = connection.ping();
                connection.close();
                
                return Health.up()
                        .withDetail("redis", "Connected")
                        .withDetail("response", pong)
                        .build();
            } catch (Exception e) {
                log.error("Redis health check failed", e);
                return Health.down()
                        .withDetail("redis", "Connection failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * Email Service Health Indicator
     */
    @Bean
    public HealthIndicator emailHealthIndicator(@Autowired EmailService emailService) {
        return () -> {
            try {
                // Test email service configuration
                boolean isConfigured = emailService.isEmailEnabled();
                
                if (isConfigured) {
                    return Health.up()
                            .withDetail("email", "Configured")
                            .withDetail("testMode", emailService.isTestMode())
                            .build();
                } else {
                    return Health.down()
                            .withDetail("email", "Not configured")
                            .build();
                }
            } catch (Exception e) {
                log.error("Email service health check failed", e);
                return Health.down()
                        .withDetail("email", "Failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * Application Business Logic Health Indicator
     */
    @Bean
    public HealthIndicator applicationHealthIndicator() {
        return () -> {
            try {
                // Check critical application components
                boolean memoryOk = checkMemoryUsage();
                boolean diskSpaceOk = checkDiskSpace();
                
                Health.Builder healthBuilder = memoryOk && diskSpaceOk ? 
                        Health.up() : Health.down();
                
                return healthBuilder
                        .withDetail("application", "JobPortal Backend")
                        .withDetail("version", "1.0.0")
                        .withDetail("memory", memoryOk ? "OK" : "HIGH")
                        .withDetail("diskSpace", diskSpaceOk ? "OK" : "LOW")
                        .withDetail("timestamp", System.currentTimeMillis())
                        .build();
                        
            } catch (Exception e) {
                log.error("Application health check failed", e);
                return Health.down()
                        .withDetail("application", "Failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * External Services Health Indicator
     */
    @Bean
    public HealthIndicator externalServicesHealthIndicator() {
        return () -> {
            try {
                // Check external service dependencies
                boolean openAIReachable = checkOpenAIService();
                
                Health.Builder healthBuilder = openAIReachable ? 
                        Health.up() : Health.down();
                
                return healthBuilder
                        .withDetail("openai", openAIReachable ? "Reachable" : "Unreachable")
                        .withDetail("lastChecked", System.currentTimeMillis())
                        .build();
                        
            } catch (Exception e) {
                log.error("External services health check failed", e);
                return Health.down()
                        .withDetail("externalServices", "Failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * Custom readiness probe for Kubernetes
     */
    @Bean
    public HealthIndicator readinessProbe() {
        return () -> {
            try {
                // Check if application is ready to serve traffic
                boolean databaseReady = true; // Check database connectivity
                boolean cacheReady = true;    // Check cache availability
                boolean configReady = true;   // Check configuration validity
                
                boolean isReady = databaseReady && cacheReady && configReady;
                
                Health.Builder healthBuilder = isReady ? Health.up() : Health.down();
                
                return healthBuilder
                        .withDetail("database", databaseReady ? "Ready" : "Not Ready")
                        .withDetail("cache", cacheReady ? "Ready" : "Not Ready")
                        .withDetail("configuration", configReady ? "Valid" : "Invalid")
                        .withDetail("readyToServe", isReady)
                        .build();
                        
            } catch (Exception e) {
                log.error("Readiness probe failed", e);
                return Health.down()
                        .withDetail("readiness", "Failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    /**
     * Custom liveness probe for Kubernetes
     */
    @Bean
    public HealthIndicator livenessProbe() {
        return () -> {
            try {
                // Check if application is alive and should not be restarted
                boolean applicationResponsive = true; // Check application responsiveness
                long memoryUsage = getMemoryUsage();
                boolean memoryOk = memoryUsage < 0.9; // Less than 90% memory usage
                
                boolean isAlive = applicationResponsive && memoryOk;
                
                Health.Builder healthBuilder = isAlive ? Health.up() : Health.down();
                
                return healthBuilder
                        .withDetail("responsive", applicationResponsive)
                        .withDetail("memoryUsage", String.format("%.2f%%", memoryUsage * 100))
                        .withDetail("alive", isAlive)
                        .build();
                        
            } catch (Exception e) {
                log.error("Liveness probe failed", e);
                return Health.down()
                        .withDetail("liveness", "Failed")
                        .withDetail("error", e.getMessage())
                        .build();
            }
        };
    }

    // Helper methods
    private boolean checkMemoryUsage() {
        Runtime runtime = Runtime.getRuntime();
        long usedMemory = runtime.totalMemory() - runtime.freeMemory();
        long maxMemory = runtime.maxMemory();
        double memoryUsage = (double) usedMemory / maxMemory;
        return memoryUsage < 0.8; // Less than 80% memory usage
    }

    private double getMemoryUsage() {
        Runtime runtime = Runtime.getRuntime();
        long usedMemory = runtime.totalMemory() - runtime.freeMemory();
        long maxMemory = runtime.maxMemory();
        return (double) usedMemory / maxMemory;
    }

    private boolean checkDiskSpace() {
        try {
            java.io.File file = new java.io.File(".");
            long freeSpace = file.getFreeSpace();
            long totalSpace = file.getTotalSpace();
            double freeSpaceRatio = (double) freeSpace / totalSpace;
            return freeSpaceRatio > 0.1; // More than 10% free space
        } catch (Exception e) {
            return true; // Assume OK if can't check
        }
    }

    private boolean checkOpenAIService() {
        // This would implement an actual check to OpenAI service
        // For now, return true as placeholder
        return true;
    }
}
